<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>é“è·¯è·¯å¯¬æŸ¥è©¢</title>
  <style>
    /* =========================================================
     * THEME SYSTEM
     * - Default: Light
     * - Toggle: data-theme="dark"
     * - Persist: localStorage key = TC_ROAD_THEME
     * ========================================================= */
    /* ============ Bigger Typography (Global) ============ */

/* 1) æ•´é«”å­—æ”¾å¤§ï¼ˆç­‰æ–¼å…¨ç«™ +12% å·¦å³ï¼‰ */
body{ font-size: 17px; }

/* 2) æ¨™é¡Œæ›´å¤§ */
h1{ font-size: 40px; }

/* 3) å‰¯æ¨™ / badge / pill æå‡å¯è®€æ€§ */
.subtitle{ font-size: 15px; }
.badge{ font-size: 13px; }
.pill{ font-size: 13px; }

/* 4) è¡¨å–®ï¼šlabel / input / select / button éƒ½åŠ å¤§ */
.field label{ font-size: 13px; }
.input, .select{ font-size: 16px; padding: 14px 14px; }
.btn{ font-size: 16px; padding: 13px 16px; }
.pager button{ font-size: 14px; }

/* 5) çµ±è¨ˆå¡ï¼šæ•¸å­—æ›´é†’ç›® */
.stat .k{ font-size: 13px; }
.stat .v{ font-size: 24px; }

/* 6) è¡¨æ ¼ï¼šæ•´é«”å­—ç´š + è·¯å¯¬å†æ›´å¼·ä¸€é» */
thead th{ font-size: 13px; padding: 14px 14px; }
tbody td{ font-size: 16px; padding: 14px 14px; }
.widthCell{ font-size: 16px; }
.widthCell .m{ font-size: 20px; }
.widthBadge{ padding: 8px 12px; }

/* 7) æ‰‹æ©Ÿå¡ç‰‡ï¼šè·¯å¯¬æ›´å¤§æ›´é†’ç›® */
.item .name{ font-size: 16px; }
.item .meta{ font-size: 13px; }
.item .width{ font-size: 20px; padding: 8px 12px; }

/* 8) ç‹€æ…‹æ¡†ä¹Ÿæ”¾å¤§ä¸€é» */
.status{ font-size: 15px; }

    :root{
      --shadow: 0 12px 40px rgba(0,0,0,.12);
      --radius:14px;
      --ring: 0 0 0 4px rgba(0, 123, 255, .18);

      /* Accent (both themes) */
      --accent:#2f7dff;
      --accent2:#10b981;   /* è·¯å¯¬ä¸»è‰² */
      --warn:#ffb020;
      --danger:#ef4444;

      /* Light default */
      --bg:#f5f7fb;
      --bg2:#eef2ff;
      --card:#ffffff;
      --card2:#f8fafc;
      --line:rgba(0,0,0,.10);
      --muted:rgba(0,0,0,.60);
      --text:rgba(0,0,0,.88);
      --head:rgba(0,0,0,.92);
      --pill:rgba(0,0,0,.04);
      --tableHead:#f3f6ff;
      --rowHover:rgba(47,125,255,.06);
      --inputBg:#ffffff;
      --inputText:rgba(0,0,0,.9);
      --selectOptionBg:#ffffff;
      --selectOptionText:rgba(0,0,0,.9);
      color-scheme: light;
    }

    /* Dark theme override */
    html[data-theme="dark"]{
      --bg:#0b1220;
      --bg2:#0b1220;
      --card:#0f1b33;
      --card2:#0d1730;
      --line:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.66);
      --text:rgba(255,255,255,.99);
      --head:rgba(255,255,255,.96);
      --pill:rgba(0,0,0,.18);
      --tableHead:rgba(15,27,51,.96);
      --rowHover:rgba(110,168,255,.08);
      --inputBg:rgba(0,0,0,.22);
      --inputText:rgba(255,255,255,.92);
      --selectOptionBg:#0b1220;
      --selectOptionText:rgba(255,255,255,.92);
      color-scheme: dark;
    }

    /* =========================================================
     * BASE
     * ========================================================= */
    *{box-sizing:border-box}
    body{
      margin:0; padding:22px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans TC", "PingFang TC", sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(47,125,255,.14), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(16,185,129,.10), transparent 55%),
        radial-gradient(1000px 700px at 50% 120%, rgba(255,176,32,.08), transparent 60%),
        var(--bg);
      color:var(--text);
      overflow-x:hidden;
    }
    html[data-theme="dark"] body{
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(110,168,255,.22), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(124,240,196,.14), transparent 55%),
        radial-gradient(1000px 700px at 50% 120%, rgba(255,204,102,.10), transparent 60%),
        var(--bg);
    }

    .wrap{max-width:1100px; margin:0 auto;}
    .header{
      display:flex; align-items:flex-end; justify-content:space-between;
      gap:12px; margin-bottom:14px; flex-wrap:wrap;
    }
    .title{display:flex; flex-direction:column; gap:6px;}
    h1{margin:0; font-size:34px; letter-spacing:.2px; color:var(--head);}
    .subtitle{color:var(--muted); font-size:13px}

    .badge{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 10px; border:1px solid var(--line); border-radius:999px;
      background:var(--pill);
      color:var(--muted); font-size:12px;
      white-space:nowrap;
    }

    /* Theme toggle button */
    .toggle{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:var(--pill);
      color:var(--text);
      cursor:pointer;
      font-size:12px;
      font-weight:750;
      user-select:none;
      transition:.2s;
    }
    .toggle:hover{transform: translateY(-1px)}
    .toggle:active{transform: translateY(0px)}
    .toggle .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(47,125,255,.35);
      box-shadow: 0 0 0 4px rgba(47,125,255,.10);
    }
    html[data-theme="dark"] .toggle .dot{
      background: rgba(110,168,255,.35);
      box-shadow: 0 0 0 4px rgba(110,168,255,.10);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.80), rgba(255,255,255,.55));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    html[data-theme="dark"] .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    }
    .card .hd{
      padding:14px 16px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--line);
      background: rgba(0,0,0,.04);
      gap:12px; flex-wrap:wrap;
    }
    html[data-theme="dark"] .card .hd{ background: rgba(0,0,0,.08); }

    .card .hd .h{
      font-weight:850; letter-spacing:.2px; font-size:14px;
      display:flex; align-items:center; gap:10px;
      color:var(--head);
    }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: var(--pill);
      color: var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    .card .bd{padding:16px}

    .status{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--pill);
      color:var(--muted);
      line-height:1.45;
    }
    .status.ok{border-color: rgba(16,185,129,.30); background: rgba(16,185,129,.08); color:var(--text)}
    .status.warn{border-color: rgba(255,176,32,.32); background: rgba(255,176,32,.10); color:var(--text)}
    .status.err{border-color: rgba(239,68,68,.30); background: rgba(239,68,68,.10); color:var(--text)}
    .status .icon{font-size:18px; line-height:1}

    .controls{
      display:grid; gap:10px;
      grid-template-columns: 1.2fr .8fr;
      align-items:end;
    }
    @media (max-width: 900px){
      .controls{grid-template-columns:1fr}
    }

    .field label{
      display:block; color:var(--muted); font-size:12px; margin-bottom:6px;
    }
    .row2{
      display:grid; gap:10px;
      grid-template-columns: repeat(2, 1fr);
    }
    @media (max-width: 720px){
      .row2{grid-template-columns:1fr}
    }
    .row3{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, 1fr);
    }
    @media (max-width: 900px){
      .row3{grid-template-columns:1fr}
    }

    .input, .select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: var(--inputBg);
      color: var(--inputText);
      outline:none;
    }
    .input:focus, .select:focus{
      border-color: rgba(47,125,255,.55);
      box-shadow: var(--ring);
    }

    /* select dropdown readability */
    .select{appearance:auto;}
    .select option{
      background: var(--selectOptionBg);
      color: var(--selectOptionText);
    }

    .btnrow{display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;}
    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;
      border-radius:12px;
      font-weight:850;
      background: rgba(47,125,255,.14);
      color: var(--head);
      border:1px solid rgba(47,125,255,.28);
      transition: transform .05s ease, background .2s ease, border .2s ease;
    }
    html[data-theme="dark"] .btn{
      background: rgba(110,168,255,.18);
      border-color: rgba(110,168,255,.35);
      color: rgba(255,255,255,.92);
    }
    .btn:hover{background: rgba(47,125,255,.20)}
    html[data-theme="dark"] .btn:hover{background: rgba(110,168,255,.28)}
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(0,0,0,.04);
      border:1px solid var(--line);
      color: var(--head);
    }
    html[data-theme="dark"] .btn.secondary{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.86);
    }
    .btn:disabled{opacity:.55; cursor:not-allowed}

    .stats{
      display:grid; gap:10px;
      grid-template-columns: repeat(4, 1fr);
    }
    @media (max-width: 900px){
      .stats{grid-template-columns: repeat(2, 1fr);}
    }
    @media (max-width: 520px){
      .stats{grid-template-columns:1fr}
    }
    .stat{
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.02);
    }
    html[data-theme="dark"] .stat{background: rgba(0,0,0,.12);}
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{margin-top:6px; font-size:20px; font-weight:900; color:var(--head)}
    .stat .v .unit{font-size:12px; color:var(--muted); font-weight:650; margin-left:6px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

    .tablewrap{
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.02);
      overflow:hidden;
    }
    html[data-theme="dark"] .tablewrap{background: rgba(0,0,0,.12);}
    table{width:100%; border-collapse:collapse;}
    thead th{
      background: var(--tableHead);
      border-bottom:1px solid var(--line);
      font-size:12px;
      color: var(--muted);
      text-align:left;
      padding:12px 12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    html[data-theme="dark"] thead th{color: rgba(255,255,255,.85);}

    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(0,0,0,.05);
      color: var(--text);
      font-size:15px;
      white-space:nowrap;
    }
    html[data-theme="dark"] tbody td{border-bottom:1px solid rgba(255,255,255,.06);}
    tbody tr:hover{background: var(--rowHover)}

    .col-width{width:170px;}
    .widthCell{font-weight:950; letter-spacing:.2px; font-size:15px; color: var(--head);}
    .widthCell .m{color: var(--accent2); font-size:18px; font-weight:950;}
    .widthBadge{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(16,185,129,.32);
      background: rgba(16,185,129,.10);
    }
    html[data-theme="dark"] .widthBadge{
      border-color: rgba(124,240,196,.30);
      background: rgba(124,240,196,.10);
    }

    .list{display:none; gap:10px; flex-direction:column;}
    .item{
      border:1px solid var(--line);
      background: rgba(0,0,0,.02);
      border-radius:12px;
      padding:12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
    }
    html[data-theme="dark"] .item{background: rgba(0,0,0,.12);}
    .item .name{font-weight:900; color:var(--head)}
    .item .meta{color:var(--muted); font-size:12px; margin-top:6px; display:flex; gap:10px; flex-wrap:wrap;}
    .item .width{
      align-self:flex-start;
      font-weight:950;
      font-size:18px;
      color: var(--accent2);
      padding:6px 10px;
      border-radius:12px;
      border:1px solid rgba(16,185,129,.32);
      background: rgba(16,185,129,.10);
      white-space:nowrap;
    }
    html[data-theme="dark"] .item .width{
      border-color: rgba(124,240,196,.30);
      background: rgba(124,240,196,.10);
      color: var(--accent2);
    }

    @media (max-width: 860px){
      .tablewrap{display:none;}
      .list{display:flex;}
      tbody td, thead th{white-space:normal;}
    }

    .footerbar{
      margin-top:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      color: var(--muted); font-size:12px;
    }
    .pager{display:flex; gap:8px; align-items:center;}
    .pager button{
      padding:8px 10px; border-radius:10px;
      border:1px solid var(--line); background: rgba(0,0,0,.03);
      color: var(--head);
      cursor:pointer;
    }
    html[data-theme="dark"] .pager button{
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.88);
    }
    .pager button:disabled{opacity:.45; cursor:not-allowed}
  </style>
</head>

<body>
<div class="wrap">

  <div class="header">
    <div class="title">
      <h1>é“è·¯è·¯å¯¬æŸ¥è©¢</h1>
      <div class="subtitle">é–‹å•Ÿé é¢æœƒè‡ªå‹•è®€å–åŒå±¤ <span class="kbd">road.csv</span>ï¼ˆä½ æ‰‹å‹•æ›´æ–°æª”æ¡ˆå³å¯ï¼‰ã€‚</div>
    </div>

    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <button class="toggle" id="themeToggle" type="button" title="åˆ‡æ› Light / Dark">
        <span class="dot"></span>
        <span id="themeText">Light</span>
      </button>
      <div class="badge" id="fileBadge">ğŸ“„ road.csvï¼šå°šæœªè¼‰å…¥</div>
    </div>
  </div>

  <div class="card">
    <div class="hd">
      <div class="h"><span class="dot"></span>æŸ¥è©¢</div>
      <div class="pill">âŒ¨ï¸ Enter æœå°‹ã€€Â·ã€€é»æ¬„ä½æ¨™é¡Œå¯æ’åº</div>
    </div>

    <div class="bd">
      <div id="status" class="status warn">
        <div class="icon">â³</div>
        <div>æ­£åœ¨è®€å– <span class="kbd">road.csv</span>â€¦</div>
      </div>

      <div style="height:12px"></div>

      <div class="controls">
        <div class="field">
          <label>è·¯åé—œéµå­—</label>
          <input class="input" type="text" id="roadName" placeholder="ä¾‹å¦‚ï¼šæ–‡å¿ƒè·¯ã€å…¬ç›Šè·¯ã€ç’°ä¸­è·¯â€¦" disabled>
        </div>
        <div class="btnrow">
          <button class="btn" id="searchBtn" onclick="queryRoadData()" disabled>æœå°‹</button>
          <button class="btn secondary" id="clearBtn" onclick="resetUI()" disabled>æ¸…é™¤</button>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row2">
        <div class="field">
          <label>è·¯å¯¬è‡³å°‘ï¼ˆâ‰¥ å…¬å°ºï¼‰</label>
          <input class="input" id="minWidth" type="number" step="0.1" placeholder="ä¾‹å¦‚ï¼š12" disabled>
        </div>
        <div class="field">
          <label>è·¯å¯¬æœ€å¤šï¼ˆâ‰¤ å…¬å°ºï¼‰</label>
          <input class="input" id="maxWidth" type="number" step="0.1" placeholder="ä¾‹å¦‚ï¼š8" disabled>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row3">
        <div class="field">
          <label>åœ°å€</label>
          <select class="select" id="areaFilter" onchange="applyFilters()" disabled>
            <option value="">å…¨éƒ¨åœ°å€</option>
          </select>
        </div>
        <div class="field">
          <label>å··</label>
          <select class="select" id="laneFilter" onchange="applyFilters()" disabled>
            <option value="">å…¨éƒ¨å··</option>
          </select>
        </div>
        <div class="field">
          <label>å¼„</label>
          <select class="select" id="alleyFilter" onchange="applyFilters()" disabled>
            <option value="">å…¨éƒ¨å¼„</option>
          </select>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row2">
        <div class="field">
          <label>æ¯é ç­†æ•¸</label>
          <select class="select" id="pageSize" onchange="renderResults()" disabled>
            <option value="20">20</option>
            <option value="50" selected>50</option>
            <option value="100">100</option>
            <option value="200">200</option>
          </select>
        </div>
        <div class="field">
          <label class="muted">æç¤º</label>
          <div class="pill">ä¸»è¦æŸ¥è·¯å¯¬ï¼šå¯å…ˆæœè·¯åï¼Œå†ç”¨ã€Œâ‰¥ / â‰¤ã€å¿«é€Ÿç¸®å°</div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="stats">
        <div class="stat">
          <div class="k">è¼‰å…¥ç­†æ•¸</div>
          <div class="v" id="statTotal">â€”</div>
        </div>
        <div class="stat">
          <div class="k">æœå°‹å‘½ä¸­</div>
          <div class="v" id="statHit">â€”</div>
        </div>
        <div class="stat">
          <div class="k">ç›®å‰é¡¯ç¤º</div>
          <div class="v" id="statShow">â€”</div>
        </div>
        <div class="stat">
          <div class="k">è·¯å¯¬ç¯„åœï¼ˆé¡¯ç¤ºçµæœï¼‰</div>
          <div class="v" id="statRange">â€”</div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div id="result"></div>

      <div class="footerbar" id="footerbar" style="display:none;">
        <div id="sortInfo">æ’åºï¼šâ€”</div>
        <div class="pager">
          <button onclick="prevPage()" id="prevBtn">ä¸Šä¸€é </button>
          <span>ç¬¬ <b id="pageNow">1</b> / <b id="pageMax">1</b> é </span>
          <button onclick="nextPage()" id="nextBtn">ä¸‹ä¸€é </button>
        </div>
      </div>

      <div class="muted small" style="margin-top:10px;">
        CSV æ¬„ä½éœ€åŒ…å«ï¼š<span class="kbd">è·¯å</span>ã€<span class="kbd">åœ°å€</span>ã€<span class="kbd">å··</span>ã€<span class="kbd">å¼„</span>ã€<span class="kbd">è·¯å¯¬</span>
      </div>
    </div>
  </div>

</div>

<script>
  // =========================
  // THEME (Light default + localStorage)
  // =========================
  const THEME_KEY = "TC_ROAD_THEME"; // 'light' | 'dark'

  function applyTheme(theme){
    const t = (theme === 'dark') ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', t === 'dark' ? 'dark' : '');
    // ç”¨ remove æ›´ä¹¾æ·¨ï¼ˆlight èµ° :rootï¼‰
    if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
    else document.documentElement.removeAttribute('data-theme');

    const label = document.getElementById('themeText');
    if(label) label.textContent = (t === 'dark') ? 'Dark' : 'Light';
  }

  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    applyTheme(saved || 'light'); // âœ… é è¨­ Light
    const btn = document.getElementById('themeToggle');
    btn.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const next = isDark ? 'light' : 'dark';
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    });
  }

  // =========================
  // State
  // =========================
  let csvData = [];
  let searchData = [];
  let viewData = [];

  let sortState = { key: null, dir: 1 };
  let page = 1;

  const $ = (id)=>document.getElementById(id);

  // =========================
  // CSV Parser (robust)
  // =========================
  function parseCSV(text){
    if(!text || !text.trim()) return [];
    text = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n");

    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for(let i=0;i<text.length;i++){
      const ch = text[i];
      if(ch === '"'){
        if(inQuotes && text[i+1] === '"'){ cur += '"'; i++; }
        else inQuotes = !inQuotes;
        continue;
      }
      if(!inQuotes && ch === ','){ row.push(cur); cur=""; continue; }
      if(!inQuotes && ch === '\n'){ row.push(cur); rows.push(row); row=[]; cur=""; continue; }
      cur += ch;
    }
    if(cur.length || row.length){ row.push(cur); rows.push(row); }

    const headers = (rows.shift()||[]).map(h => (h||"").trim().replace(/^"|"$/g,""));
    if(!headers.length) return [];

    return rows
      .filter(r => r.some(v => String(v||"").trim() !== ""))
      .map(r => {
        const o = {};
        headers.forEach((h,idx)=> o[h] = (r[idx] ?? "").trim().replace(/^"|"$/g,""));
        return o;
      });
  }

  // =========================
  // Helpers
  // =========================
  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m)=>({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function setStatus(type, html){
    const el = $('status');
    const icon = type==='ok'?'âœ…':type==='err'?'âŒ':type==='warn'?'âš ï¸':'â³';
    el.className = `status ${type}`;
    el.innerHTML = `<div class="icon">${icon}</div><div>${html}</div>`;
  }

  function widthToNumber(v){
    const n = parseFloat(String(v ?? '').replace(/[^\d.]/g,''));
    return Number.isFinite(n) ? n : null;
  }

  function formatWidth(v){
    const n = widthToNumber(v);
    if(n === null) return { text: escapeHtml(v || 'ç„¡è³‡æ–™'), num: null };
    const pretty = (Math.round(n * 10) / 10).toString();
    return { text: pretty, num: n };
  }

  function computeWidthRange(rows){
    const nums = rows.map(r => widthToNumber(r['è·¯å¯¬'])).filter(n => n !== null);
    if(!nums.length) return null;
    nums.sort((a,b)=>a-b);
    return { min: nums[0], max: nums[nums.length-1] };
  }

  // =========================
  // Load CSV
  // =========================
  window.onload = () => {
    initTheme();     // âœ… å…ˆè¼‰å…¥ä¸»é¡Œï¼ˆé¿å…é–ƒçˆï¼‰
    loadCSV();
  };

  async function loadCSV(){
    try{
      setStatus('loading', `æ­£åœ¨è®€å– <span class="kbd">road.csv</span>â€¦`);
      $('fileBadge').textContent = 'ğŸ“„ road.csvï¼šè¼‰å…¥ä¸­â€¦';

      const url = `./road.csv?v=${Date.now()}`;
      const res = await fetch(url, { cache:'no-store' });
      if(!res.ok) throw new Error(`HTTP ${res.status}ï¼šæ‰¾ä¸åˆ° road.csv æˆ–ç„¡æ³•è®€å–`);

      const text = await res.text();
      csvData = parseCSV(text);
      if(!csvData.length) throw new Error('road.csv è§£æä¸åˆ°è³‡æ–™ï¼ˆå¯èƒ½ç‚ºç©ºæˆ–æ ¼å¼ç•°å¸¸ï¼‰');

      ['roadName','minWidth','maxWidth','areaFilter','laneFilter','alleyFilter','pageSize'].forEach(id => $(id).disabled = false);
      $('searchBtn').disabled = false;
      $('clearBtn').disabled = false;

      $('statTotal').textContent = csvData.length.toLocaleString();
      $('fileBadge').textContent = `ğŸ“„ road.csvï¼šå·²è¼‰å…¥ ${csvData.length.toLocaleString()} ç­†`;
      setStatus('ok', `å·²è¼‰å…¥ <b>${csvData.length.toLocaleString()}</b> ç­†è³‡æ–™ï¼Œå¯é–‹å§‹æŸ¥è©¢ã€‚`);

      $('roadName').focus();

      $('minWidth').addEventListener('input', debounce(()=>applyFilters(true), 250));
      $('maxWidth').addEventListener('input', debounce(()=>applyFilters(true), 250));

    }catch(err){
      console.error(err);
      $('fileBadge').textContent = 'ğŸ“„ road.csvï¼šè¼‰å…¥å¤±æ•—';
      setStatus('err',
        `è®€å–å¤±æ•—ï¼š${escapeHtml(err.message)}<br><br>`+
        `è«‹ç¢ºèªï¼š<br>`+
        `1) <span class="kbd">tc-road.html</span> èˆ‡ <span class="kbd">road.csv</span> æ˜¯å¦åŒä¸€è³‡æ–™å¤¾<br>`+
        `2) GitHub Pages å·²éƒ¨ç½²å®Œæˆï¼ˆç”¨ç¶²å€ç›´æ¥é–‹ road.csv æœƒæœ‰å…§å®¹ï¼‰`
      );
    }
  }

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter' && document.activeElement === $('roadName') && !$('roadName').disabled){
      queryRoadData();
    }
  });

  function debounce(fn, ms){
    let t = null;
    return (...args)=>{
      clearTimeout(t);
      t = setTimeout(()=>fn(...args), ms);
    };
  }

  // =========================
  // Search + Filters
  // =========================
  function queryRoadData(){
    const kw = $('roadName').value.trim();
    if(!csvData.length){
      setStatus('warn','è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™æˆ–é‡æ•´ã€‚'); return;
    }
    if(!kw){
      setStatus('warn','è«‹è¼¸å…¥è·¯åé—œéµå­—å†æœå°‹ã€‚');
      $('result').innerHTML = '';
      $('footerbar').style.display = 'none';
      return;
    }

    searchData = csvData.filter(r => String(r['è·¯å']||'').includes(kw));
    if(!searchData.length){
      setStatus('warn', `æŸ¥ç„¡åŒ…å«ã€Œ<b>${escapeHtml(kw)}</b>ã€çš„è³‡æ–™ã€‚`);
      resetFiltersOnly();
      updateStats(0,0,null);
      $('result').innerHTML = '';
      $('footerbar').style.display = 'none';
      return;
    }

    populateFilters(searchData);
    sortState = { key:null, dir:1 };
    page = 1;
    applyFilters(true);

    setStatus('ok', `æ‰¾åˆ° <b>${searchData.length.toLocaleString()}</b> ç­†å‘½ä¸­ã€‚å¯ç”¨ã€Œè·¯å¯¬ â‰¥ / â‰¤ã€å¿«é€Ÿç¸®å°ã€‚`);
  }

  function applyFilters(keepPage){
    if(!searchData.length) return;

    const a = $('areaFilter').value;
    const l = $('laneFilter').value;
    const al = $('alleyFilter').value;

    const minW = $('minWidth').value === '' ? null : parseFloat($('minWidth').value);
    const maxW = $('maxWidth').value === '' ? null : parseFloat($('maxWidth').value);

    viewData = searchData.filter(r => {
      const okA = !a || r['åœ°å€'] === a;
      const okL = !l || r['å··'] === l;
      const okAl= !al || r['å¼„'] === al;

      const wn = widthToNumber(r['è·¯å¯¬']);
      const okMin = (minW === null) || (wn !== null && wn >= minW);
      const okMax = (maxW === null) || (wn !== null && wn <= maxW);

      return okA && okL && okAl && okMin && okMax;
    });

    if(!keepPage) page = 1;
    renderResults();
  }

  function populateFilters(data){
    const areaSet = new Set(data.map(r => r['åœ°å€']).filter(v => v && v !== 'ç„¡è³‡æ–™'));
    const laneSet = new Set(data.map(r => r['å··']).filter(v => v && v !== 'ç„¡è³‡æ–™'));
    const alleySet= new Set(data.map(r => r['å¼„']).filter(v => v && v !== 'ç„¡è³‡æ–™'));

    $('areaFilter').innerHTML = '<option value="">å…¨éƒ¨åœ°å€</option>';
    $('laneFilter').innerHTML = '<option value="">å…¨éƒ¨å··</option>';
    $('alleyFilter').innerHTML= '<option value="">å…¨éƒ¨å¼„</option>';

    [...areaSet].sort().forEach(v => $('areaFilter').add(new Option(v, v)));
    [...laneSet].sort().forEach(v => $('laneFilter').add(new Option(v, v)));
    [...alleySet].sort().forEach(v => $('alleyFilter').add(new Option(v, v)));
  }

  function resetFiltersOnly(){
    $('areaFilter').value = '';
    $('laneFilter').value = '';
    $('alleyFilter').value = '';
    $('minWidth').value = '';
    $('maxWidth').value = '';
    $('areaFilter').innerHTML = '<option value="">å…¨éƒ¨åœ°å€</option>';
    $('laneFilter').innerHTML = '<option value="">å…¨éƒ¨å··</option>';
    $('alleyFilter').innerHTML = '<option value="">å…¨éƒ¨å¼„</option>';
  }

  function resetUI(){
    $('roadName').value = '';
    resetFiltersOnly();
    $('result').innerHTML = '';
    $('footerbar').style.display = 'none';
    searchData = [];
    viewData = [];
    sortState = { key:null, dir:1 };
    page = 1;
    updateStats(null,null,null);
    setStatus('ok','å·²æ¸…é™¤ã€‚è«‹é‡æ–°è¼¸å…¥è·¯åæŸ¥è©¢ã€‚');
    $('roadName').focus();
  }

  // =========================
  // Sorting + Pagination + Rendering
  // =========================
  function sortBy(key){
    if(!viewData.length) return;
    if(sortState.key === key) sortState.dir *= -1;
    else sortState = { key, dir: 1 };
    renderResults(true);
  }

  function getSortedData(){
    const { key, dir } = sortState;
    const arr = viewData.slice();
    if(!key) return arr;

    arr.sort((a,b)=>{
      if(key === 'è·¯å¯¬'){
        const an = widthToNumber(a['è·¯å¯¬']);
        const bn = widthToNumber(b['è·¯å¯¬']);
        if(an === null && bn === null) return String(a['è·¯å¯¬']||'').localeCompare(String(b['è·¯å¯¬']||''),'zh-Hant') * dir;
        if(an === null) return 1;
        if(bn === null) return -1;
        return (an - bn) * dir;
      }
      return String(a[key]||'').localeCompare(String(b[key]||''),'zh-Hant') * dir;
    });
    return arr;
  }

  function renderResults(keepPage=false){
    const resultDiv = $('result');

    const range = computeWidthRange(viewData);
    updateStats(csvData.length, searchData.length, range);

    if(!viewData.length){
      resultDiv.innerHTML = `<div class="status warn"><div class="icon">âš ï¸</div><div>æ²’æœ‰ç¬¦åˆç›®å‰ç¯©é¸æ¢ä»¶çš„è³‡æ–™ã€‚</div></div>`;
      $('footerbar').style.display = 'none';
      return;
    }

    const pageSize = parseInt($('pageSize').value, 10) || 50;
    const sorted = getSortedData();

    const maxPage = Math.max(1, Math.ceil(sorted.length / pageSize));
    if(!keepPage) page = 1;
    if(page > maxPage) page = maxPage;

    const start = (page - 1) * pageSize;
    const slice = sorted.slice(start, start + pageSize);

    $('footerbar').style.display = 'flex';
    $('pageNow').textContent = page;
    $('pageMax').textContent = maxPage;
    $('prevBtn').disabled = page <= 1;
    $('nextBtn').disabled = page >= maxPage;

    const sortLabel = sortState.key ? `${sortState.key}ï¼ˆ${sortState.dir===1?'å‡å†ª':'é™å†ª'}ï¼‰` : 'æœªæ’åº';
    $('sortInfo').textContent = `æ’åºï¼š${sortLabel}`;

    resultDiv.innerHTML = `
      <div class="tablewrap">
        <table>
          <thead>
            <tr>
              <th style="width:70px">#</th>
              <th onclick="sortBy('è·¯å')">è·¯å</th>
              <th onclick="sortBy('åœ°å€')">åœ°å€</th>
              <th onclick="sortBy('å··')">å··</th>
              <th onclick="sortBy('å¼„')">å¼„</th>
              <th class="col-width" onclick="sortBy('è·¯å¯¬')">è·¯å¯¬ï¼ˆå…¬å°ºï¼‰</th>
            </tr>
          </thead>
          <tbody>
            ${slice.map((r, idx)=>{
              const w = formatWidth(r['è·¯å¯¬']);
              return `
                <tr>
                  <td>${start + idx + 1}</td>
                  <td>${escapeHtml(r['è·¯å'] || 'ç„¡è³‡æ–™')}</td>
                  <td>${escapeHtml(r['åœ°å€'] || 'ç„¡è³‡æ–™')}</td>
                  <td>${escapeHtml(r['å··'] || 'ç„¡è³‡æ–™')}</td>
                  <td>${escapeHtml(r['å¼„'] || 'ç„¡è³‡æ–™')}</td>
                  <td class="widthCell">
                    <span class="widthBadge">ğŸ“ <span class="m">${escapeHtml(w.text)}</span> m</span>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>

      <div class="list">
        ${slice.map((r, idx)=>{
          const w = formatWidth(r['è·¯å¯¬']);
          return `
            <div class="item">
              <div>
                <div class="name">${escapeHtml(r['è·¯å'] || 'ç„¡è³‡æ–™')}</div>
                <div class="meta">
                  <span>ğŸ“ ${escapeHtml(r['åœ°å€'] || 'ç„¡è³‡æ–™')}</span>
                  <span>å··ï¼š${escapeHtml(r['å··'] || 'â€”')}</span>
                  <span>å¼„ï¼š${escapeHtml(r['å¼„'] || 'â€”')}</span>
                  <span class="muted">#${start + idx + 1}</span>
                </div>
              </div>
              <div class="width">ğŸ“ ${escapeHtml(w.text)} m</div>
            </div>
          `;
        }).join('')}
      </div>
    `;
  }

  function updateStats(total, hit, range){
    if(total !== null) $('statTotal').textContent = Number(total).toLocaleString();
    if(hit !== null) $('statHit').textContent = Number(hit).toLocaleString();
    $('statShow').textContent = viewData.length ? viewData.length.toLocaleString() : '0';

    if(!range){
      $('statRange').innerHTML = `â€”`;
      return;
    }
    const min = Math.round(range.min * 10)/10;
    const max = Math.round(range.max * 10)/10;
    $('statRange').innerHTML =
      `<span style="color:var(--accent2); font-weight:950;">${min}</span>`+
      ` ï½ `+
      `<span style="color:var(--accent2); font-weight:950;">${max}</span>`+
      `<span class="unit">m</span>`;
  }

  function prevPage(){ page = Math.max(1, page-1); renderResults(true); }
  function nextPage(){
    const pageSize = parseInt($('pageSize').value, 10) || 50;
    const maxPage = Math.max(1, Math.ceil(viewData.length / pageSize));
    page = Math.min(maxPage, page+1);
    renderResults(true);
  }
</script>
</body>
</html>




