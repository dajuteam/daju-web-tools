<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å°ä¸­é“è·¯è³‡è¨ŠæŸ¥è©¢ï¼ˆAPI ç‰ˆï¼‰</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 900px; margin: 0 auto; text-align: center; }
    input, button, select { padding: 10px; margin: 5px; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    .road-width { color: red; font-weight: bold; }
    #status { margin: 20px 0; font-size: 16px; padding: 15px; border-radius: 4px; }
    .success { color: #2e7d32; background-color: #e8f5e9; border: 1px solid #4caf50; }
    .error { color: #d32f2f; background-color: #ffebee; border: 1px solid #f44336; }
    .loading { color: #f57f17; background-color: #fffde7; border: 1px solid #ffeb3b; }
    .search-section { margin: 30px 0; }
    #roadName { width: 320px; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; }
    .search-btn { background-color: #2196F3; color: white; border: none; padding: 12px 24px; font-size: 16px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
    .search-btn:hover { background-color: #1976D2; }
    .search-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
    .hint { color:#666; font-size:13px; margin-top:6px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>é“è·¯è³‡è¨ŠæŸ¥è©¢ï¼ˆAPI ç‰ˆï¼‰</h1>

    <div id="status" class="success">
      âœ… å·²å°±ç·’ï¼šè¼¸å…¥è·¯åé—œéµå­—å¾Œæœå°‹ï¼ˆè³‡æ–™ä¾†æºï¼šè‡ºä¸­å¸‚ OpenData APIï¼‰
    </div>

    <div class="search-section">
      <input type="text" id="roadName" placeholder="è¼¸å…¥è·¯åé—œéµå­—ï¼ˆä¾‹ï¼šè¡›é“ã€æ–‡å¿ƒã€ç’°ä¸­ï¼‰">
      <button class="search-btn" id="searchBtn" onclick="queryRoadData()">æœå°‹</button>
      <div class="hint">æç¤ºï¼šè³‡æ–™é‡å¤§æ™‚æœƒè‡ªå‹•åˆ†é æŠ“å–ï¼›åŒé—œéµå­—çŸ­æ™‚é–“é‡æŸ¥æœƒèµ°å¿«å–ã€‚</div>
    </div>

    <div id="filters" style="display:none;">
      <select id="areaFilter" onchange="applyFilters()">
        <option value="">æ‰€æœ‰åœ°å€</option>
      </select>
      <select id="laneFilter" onchange="applyFilters()">
        <option value="">æ‰€æœ‰å··</option>
      </select>
      <select id="alleyFilter" onchange="applyFilters()">
        <option value="">æ‰€æœ‰å¼„</option>
      </select>
    </div>

    <div id="result"></div>
  </div>

  <script>
    // =========================
    // âœ… è¨­å®šå€ï¼šAPI
    // =========================
    const API_BASE = "https://datacenter.taichung.gov.tw/swagger/OpenData/c807c4ef-1942-4341-abbc-883fde09f8b2";
    // â†‘ è‹¥ä½ ä¹‹å¾Œç¢ºèª Swagger çœŸæ­£çš„è³‡æ–™ API ç«¯é»ä¸æ˜¯é€™å€‹ UI URLï¼Œ
    //   åªè¦æŠŠå®ƒæ›æˆã€Œå› JSON çš„é‚£æ”¯ã€å³å¯ï¼ˆå…¶é¤˜ç¨‹å¼å¯ä¸å‹•ï¼‰ã€‚

    const DEFAULT_LIMIT = 1000;        // API é è¨­æ¯é  1000
    const MAX_TOTAL_ROWS = 20000;      // å®‰å…¨ä¸Šé™ï¼šé¿å…é—œéµå­—å¤ªçŸ­æŠŠå…¨å¸‚éƒ½æ’ˆçˆ†
    const CACHE_TTL_MS = 10 * 60 * 1000; // sessionStorage å¿«å– 10 åˆ†é˜

    // =========================
    // ç‹€æ…‹
    // =========================
    let apiData = [];
    let filteredData = [];

    // =========================
    // å°å·¥å…·ï¼šç‹€æ…‹é¡¯ç¤º
    // =========================
    function setStatus(type, html) {
      const statusDiv = document.getElementById("status");
      statusDiv.className = type;
      statusDiv.innerHTML = html;
    }

    // =========================
    // å°å·¥å…·ï¼šå¾å¤šç¨®å€™é¸ key å–å€¼ï¼ˆå®¹éŒ¯ï¼‰
    // =========================
    function pick(obj, keys, fallback = "ç„¡è³‡æ–™") {
      for (const k of keys) {
        if (obj && Object.prototype.hasOwnProperty.call(obj, k)) {
          const v = obj[k];
          if (v !== undefined && v !== null && String(v).trim() !== "") return String(v);
        }
      }
      return fallback;
    }

    // ä½ çš„é¡¯ç¤ºæ¬„ä½ï¼ˆå€™é¸ keyï¼‰
    const KEY_ROAD  = ["è·¯å","ROADNAME","road_name","name","é“è·¯åç¨±"];
    const KEY_AREA  = ["åœ°å€","å€","è¡Œæ”¿å€","DISTRICT","district","è½„å€"];
    const KEY_LANE  = ["å··","LANE","lane"];
    const KEY_ALLEY = ["å¼„","ALLEY","alley"];
    const KEY_WIDTH = ["è·¯å¯¬","è·¯å¯¬(å…¬å°º)","ROADWIDTH","width","è·¯å¹…","è·¯å¯¬åº¦"];

    // =========================
    // âœ… APIï¼šå–è³‡æ–™ï¼ˆæ”¯æ´ q / filters / fields / offset / limitï¼‰
    // =========================
    function buildApiUrl(params) {
      const usp = new URLSearchParams();
      for (const [k, v] of Object.entries(params)) {
        if (v === undefined || v === null || v === "") continue;
        usp.set(k, String(v));
      }
      return `${API_BASE}?${usp.toString()}`;
    }

    function normalizeRecords(payload) {
      // å¸¸è¦‹æ ¼å¼ï¼š
      // 1) Array
      // 2) { result: { records: [...] } }
      // 3) { records: [...] }
      // 4) { data: [...] }
      if (Array.isArray(payload)) return payload;
      if (payload?.result?.records && Array.isArray(payload.result.records)) return payload.result.records;
      if (payload?.records && Array.isArray(payload.records)) return payload.records;
      if (payload?.data && Array.isArray(payload.data)) return payload.data;
      return [];
    }

    function cacheKeyForQuery(q) {
      return `ROAD_API_CACHE::${q}`;
    }

    function getCache(q) {
      try {
        const raw = sessionStorage.getItem(cacheKeyForQuery(q));
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !obj.ts || !obj.data) return null;
        if (Date.now() - obj.ts > CACHE_TTL_MS) return null;
        return obj.data;
      } catch {
        return null;
      }
    }

    function setCache(q, data) {
      try {
        sessionStorage.setItem(cacheKeyForQuery(q), JSON.stringify({ ts: Date.now(), data }));
      } catch {}
    }

    async function fetchAllByQuery(q) {
      const cached = getCache(q);
      if (cached) return cached;

      let all = [];
      let offset = 0;

      while (true) {
        // ç”¨ q åšå…¨æ–‡æª¢ç´¢ï¼ˆä½ æä¾›çš„åƒæ•¸ï¼‰
        const url = buildApiUrl({
          q,
          limit: DEFAULT_LIMIT,
          offset
          // fields: "è·¯å,åœ°å€,å··,å¼„,è·¯å¯¬"  // å¦‚æœä½ ç¢ºèªæ¬„ä½åå®Œå…¨ä¸€è‡´ï¼Œå¯é–‹å•Ÿä»¥æ¸›å°‘æµé‡
        });

        const res = await fetch(url, { method: "GET" });
        if (!res.ok) throw new Error(`API HTTP ${res.status}`);

        const payload = await res.json();
        const rows = normalizeRecords(payload);

        all = all.concat(rows);

        // åˆ†é çµæŸæ¢ä»¶
        if (rows.length < DEFAULT_LIMIT) break;

        offset += DEFAULT_LIMIT;

        // å®‰å…¨ä¸Šé™
        if (all.length >= MAX_TOTAL_ROWS) break;
      }

      setCache(q, all);
      return all;
    }

    // =========================
    // âœ… æŸ¥è©¢ï¼šæŒ‰éˆ• / Enter
    // =========================
    async function queryRoadData() {
      const roadName = document.getElementById("roadName").value.trim();
      const filtersDiv = document.getElementById("filters");
      const resultDiv = document.getElementById("result");

      if (!roadName) {
        resultDiv.innerHTML = '<p style="color:red; padding:10px;">è«‹è¼¸å…¥è·¯åçš„é—œéµå­—ï¼</p>';
        filtersDiv.style.display = "none";
        return;
      }

      // å»ºè­°ï¼šé¿å…ä¸€å€‹å­—æ’ˆçˆ†
      if (roadName.length < 2) {
        resultDiv.innerHTML = '<p style="color:red; padding:10px;">é—œéµå­—å¤ªçŸ­ï¼Œå»ºè­°è‡³å°‘ 2 å€‹å­—ï¼ˆé¿å…æ’ˆåˆ°éå¤šè³‡æ–™ï¼‰ã€‚</p>';
        filtersDiv.style.display = "none";
        return;
      }

      try {
        document.getElementById("searchBtn").disabled = true;
        setStatus("loading", `ğŸ”„ æŸ¥è©¢ä¸­ï¼šæ­£åœ¨å‘ API æœå°‹ã€Œ${roadName}ã€...`);

        apiData = await fetchAllByQuery(roadName);

        // ä½ åŸæœ¬æ˜¯ç”¨ includes(roadName) æ¯”å°ã€Œè·¯åã€æ¬„ä½
        // é€™è£¡ä»ä¿ç•™ï¼šå†åšä¸€æ¬¡å‰ç«¯ç²¾æº–éæ¿¾ï¼ˆé¿å… q å‘½ä¸­å…¶å®ƒæ¬„ä½é€ æˆé›œè¨Šï¼‰
        filteredData = apiData.filter(row => {
          const rn = pick(row, KEY_ROAD, "");
          return rn.includes(roadName);
        });

        if (filteredData.length === 0) {
          resultDiv.innerHTML = `<p style="padding:10px;">æ²’æœ‰æ‰¾åˆ°åŒ…å«ã€Œ${roadName}ã€çš„é“è·¯è³‡æ–™ã€‚</p>`;
          filtersDiv.style.display = "none";
          setStatus("success", `âœ… API æŸ¥è©¢å®Œæˆï¼Œä½†ç„¡ç¬¦åˆã€Œè·¯ååŒ…å« ${roadName}ã€çš„è³‡æ–™ï¼ˆq å‘½ä¸­å¯èƒ½åœ¨å…¶ä»–æ¬„ä½ï¼‰ã€‚`);
          return;
        }

        populateFilters();
        filtersDiv.style.display = "block";
        displayResults(filteredData);

        setStatus("success", `âœ… æŸ¥è©¢å®Œæˆï¼šæ‰¾åˆ° ${filteredData.length} ç­†ã€Œè·¯ååŒ…å« ${roadName}ã€çš„è³‡æ–™ï¼ˆAPI å›å‚³ ${apiData.length} ç­†ï¼‰ã€‚`);

        // è‹¥è§¸ç™¼ä¸Šé™æé†’
        if (apiData.length >= MAX_TOTAL_ROWS) {
          setStatus("loading", `âš ï¸ è³‡æ–™é‡å¯èƒ½éå¤§ï¼šå·²é”ä¸Šé™ ${MAX_TOTAL_ROWS} ç­†ï¼ˆå»ºè­°é—œéµå­—å†æ›´ç²¾æº–ï¼Œä¾‹å¦‚åŠ ä¸Šã€Œè·¯/è¡—/å¤§é“ã€ï¼‰ã€‚`);
        }
      } catch (err) {
        console.error(err);
        setStatus("error", `âŒ æŸ¥è©¢å¤±æ•—ï¼š${err.message}<br>å¯èƒ½åŸå› ï¼šAPI ç«¯é»ä¸æ˜¯å› JSON çš„é‚£æ”¯ã€æˆ–ç€è¦½å™¨ CORS è¢«æ“‹ã€‚`);
        resultDiv.innerHTML = '';
        filtersDiv.style.display = "none";
      } finally {
        document.getElementById("searchBtn").disabled = false;
      }
    }

    // =========================
    // ç¯©é¸å™¨ï¼šæ²¿ç”¨ä½ åŸæœ¬é‚è¼¯
    // =========================
    function populateFilters() {
      const areaSet = new Set(filteredData.map(row => pick(row, KEY_AREA, "")).filter(v => v && v !== "ç„¡è³‡æ–™"));
      const laneSet = new Set(filteredData.map(row => pick(row, KEY_LANE, "")).filter(v => v && v !== "ç„¡è³‡æ–™"));
      const alleySet = new Set(filteredData.map(row => pick(row, KEY_ALLEY, "")).filter(v => v && v !== "ç„¡è³‡æ–™"));

      const areaFilter = document.getElementById("areaFilter");
      const laneFilter = document.getElementById("laneFilter");
      const alleyFilter = document.getElementById("alleyFilter");

      areaFilter.innerHTML = '<option value="">æ‰€æœ‰åœ°å€</option>';
      laneFilter.innerHTML = '<option value="">æ‰€æœ‰å··</option>';
      alleyFilter.innerHTML = '<option value="">æ‰€æœ‰å¼„</option>';

      [...areaSet].sort().forEach(area => {
        const opt = document.createElement("option");
        opt.value = area;
        opt.textContent = area;
        areaFilter.appendChild(opt);
      });

      [...laneSet].sort().forEach(lane => {
        const opt = document.createElement("option");
        opt.value = lane;
        opt.textContent = lane;
        laneFilter.appendChild(opt);
      });

      [...alleySet].sort().forEach(alley => {
        const opt = document.createElement("option");
        opt.value = alley;
        opt.textContent = alley;
        alleyFilter.appendChild(opt);
      });
    }

    function applyFilters() {
      const areaFilter = document.getElementById("areaFilter").value;
      const laneFilter = document.getElementById("laneFilter").value;
      const alleyFilter = document.getElementById("alleyFilter").value;

      const results = filteredData.filter(row => {
        const a = pick(row, KEY_AREA, "ç„¡è³‡æ–™");
        const l = pick(row, KEY_LANE, "ç„¡è³‡æ–™");
        const al = pick(row, KEY_ALLEY, "ç„¡è³‡æ–™");
        const areaMatch = !areaFilter || a === areaFilter;
        const laneMatch = !laneFilter || l === laneFilter;
        const alleyMatch = !alleyFilter || al === alleyFilter;
        return areaMatch && laneMatch && alleyMatch;
      });

      displayResults(results);
    }

    function displayResults(results) {
      const resultDiv = document.getElementById("result");
      const filtersDiv = document.getElementById("filters");

      if (!results || results.length === 0) {
        resultDiv.innerHTML = '<p style="padding:10px;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™ã€‚</p>';
        return;
      }

      let html = `
        <p style="margin:20px 0; font-weight:bold;">æ‰¾åˆ° ${results.length} ç­†è³‡æ–™ï¼š</p>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>è·¯å</th>
              <th>åœ°å€</th>
              <th>å··</th>
              <th>å¼„</th>
              <th>è·¯å¯¬</th>
            </tr>
          </thead>
          <tbody>
      `;

      results.forEach((item, idx) => {
        const rn = pick(item, KEY_ROAD);
        const ar = pick(item, KEY_AREA);
        const ln = pick(item, KEY_LANE);
        const ay = pick(item, KEY_ALLEY);
        const wd = pick(item, KEY_WIDTH);

        html += `
          <tr>
            <td>${idx + 1}</td>
            <td>${rn}</td>
            <td>${ar}</td>
            <td>${ln}</td>
            <td>${ay}</td>
            <td class="road-width">${wd}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      resultDiv.innerHTML = html;
      filtersDiv.style.display = "block";
    }

    // Enter æœå°‹
    document.getElementById("roadName").addEventListener("keypress", function(e) {
      if (e.key === "Enter") queryRoadData();
    });
  </script>
</body>
</html>
