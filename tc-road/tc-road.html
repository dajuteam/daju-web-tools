<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é“è·¯è³‡è¨ŠæŸ¥è©¢</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 900px; margin: 0 auto; text-align: center; }
    input, button, select { padding: 10px; margin: 5px; font-size: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f4f4f4; }
    .road-width { color: red; font-weight: bold; }
    #status { margin: 20px 0; font-size: 16px; padding: 15px; border-radius: 4px; text-align:left; }
    .success { color: #2e7d32; background-color: #e8f5e9; border: 1px solid #4caf50; }
    .error { color: #d32f2f; background-color: #ffebee; border: 1px solid #f44336; }
    .loading { color: #f57f17; background-color: #fffde7; border: 1px solid #ffeb3b; }
    .search-section { margin: 30px 0; }
    #roadName {
      width: 320px; padding: 12px; font-size: 16px;
      border: 2px solid #ddd; border-radius: 4px;
    }
    .search-btn {
      background-color: #2196F3; color: white; border: none;
      padding: 12px 24px; font-size: 16px; border-radius: 4px;
      cursor: pointer; margin-left: 10px;
    }
    .search-btn:hover { background-color: #1976D2; }
    .search-btn:disabled { background-color: #cccccc; cursor: not-allowed; }
    .muted { color:#666; font-size: 13px; margin-top: 8px; }
  </style>
</head>
<body>
<div class="container">
  <h1>é“è·¯è³‡è¨ŠæŸ¥è©¢</h1>

  <div id="status" class="loading">ğŸ”„ æ­£åœ¨è®€å– road.csvï¼ˆç”± GitHub Actions æ¯æ—¥æ›´æ–°ï¼‰â€¦</div>

  <div class="search-section">
    <input type="text" id="roadName" placeholder="è¼¸å…¥è·¯åé—œéµå­—" disabled>
    <button class="search-btn" id="searchBtn" onclick="queryRoadData()" disabled>æœå°‹</button>
    <div class="muted">æç¤ºï¼šroad.csv åœ¨åŒä¸€è³‡æ–™å¤¾ï¼›è‹¥å‰›æ›´æ–°æ²’ç”Ÿæ•ˆï¼Œå¯é‡æ•´æˆ–ç­‰ CDN å¿«å–åˆ·æ–°ã€‚</div>
  </div>

  <div id="filters" style="display:none;">
    <select id="areaFilter" onchange="applyFilters()">
      <option value="">æ‰€æœ‰åœ°å€</option>
    </select>
    <select id="laneFilter" onchange="applyFilters()">
      <option value="">æ‰€æœ‰å··</option>
    </select>
    <select id="alleyFilter" onchange="applyFilters()">
      <option value="">æ‰€æœ‰å¼„</option>
    </select>
  </div>

  <div id="result"></div>
</div>

<script>
  let csvData = [];
  let filteredData = [];

  window.onload = () => loadCSVFromServer();

  function setStatus(type, html) {
    const s = document.getElementById('status');
    s.className = type;
    s.innerHTML = html;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // âœ… ç©©å®š CSV parserï¼ˆæ”¯æ´å¼•è™Ÿã€é€—è™Ÿã€CRLFï¼‰
  function parseCSV(text) {
    if (!text || !text.trim()) return [];

    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];

      if (ch === '"') {
        if (inQuotes && text[i + 1] === '"') { // "" -> "
          cur += '"';
          i++;
        } else {
          inQuotes = !inQuotes;
        }
        continue;
      }

      if (!inQuotes && ch === ",") {
        row.push(cur);
        cur = "";
        continue;
      }

      if (!inQuotes && ch === "\n") {
        row.push(cur);
        rows.push(row);
        row = [];
        cur = "";
        continue;
      }

      cur += ch;
    }

    if (cur.length || row.length) {
      row.push(cur);
      rows.push(row);
    }

    const headers = (rows.shift() || []).map(h => (h || "").trim().replace(/^"|"$/g, ""));
    if (!headers.length) return [];

    return rows
      .filter(r => r.some(v => String(v || "").trim() !== ""))
      .map(r => {
        const obj = {};
        headers.forEach((h, idx) => {
          obj[h] = (r[idx] ?? "").trim().replace(/^"|"$/g, "");
        });
        return obj;
      });
  }

  async function loadCSVFromServer() {
    const roadNameInput = document.getElementById('roadName');
    const searchBtn = document.getElementById('searchBtn');

    try {
      setStatus('loading', 'ğŸ”„ æ­£åœ¨è®€å– road.csvï¼ˆç”± GitHub Actions æ¯æ—¥æ›´æ–°ï¼‰â€¦');

      // âœ… å¿«å– bustï¼šé¿å…æ›´æ–°å¾Œé‚„æ‹¿èˆŠæª”ï¼ˆå¯æ”¹æˆä½ çš„ç‰ˆæœ¬è™Ÿï¼‰
      const filePath = `./road.csv?v=${Date.now()}`;

      const response = await fetch(filePath, { cache: "no-store" });
      if (!response.ok) {
        throw new Error(`ç„¡æ³•è¼‰å…¥ road.csv (HTTP ${response.status})`);
      }

      const text = await response.text();
      csvData = parseCSV(text);

      if (!csvData.length) {
        throw new Error('road.csv å…§å®¹ç‚ºç©ºæˆ–è§£æä¸åˆ°è³‡æ–™');
      }

      setStatus('success', `âœ… road.csv è®€å–æˆåŠŸï¼šå…± ${csvData.length} ç­†ï¼Œå¯é–‹å§‹æŸ¥è©¢ã€‚`);
      roadNameInput.disabled = false;
      searchBtn.disabled = false;
      roadNameInput.focus();

    } catch (error) {
      console.error(error);
      setStatus(
        'error',
        `âŒ è®€å– road.csv å¤±æ•—ï¼š${escapeHtml(error.message)}<br><br>` +
        `è«‹ç¢ºèªï¼š<br>` +
        `1) repo æ ¹ç›®éŒ„ï¼ˆæˆ–åŒå±¤è³‡æ–™å¤¾ï¼‰æ˜¯å¦æœ‰ road.csv<br>` +
        `2) GitHub Actions æ˜¯å¦å·²è·‘éï¼ˆå¯æ‰‹å‹• Run workflowï¼‰<br>`
      );
      roadNameInput.disabled = true;
      searchBtn.disabled = true;
    }
  }

  function queryRoadData() {
    const roadName = document.getElementById('roadName').value.trim();
    const resultDiv = document.getElementById('result');
    const filtersDiv = document.getElementById('filters');

    if (!csvData.length) {
      resultDiv.innerHTML = '<p style="color:red; padding:10px;">CSV å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™å†è©¦ã€‚</p>';
      filtersDiv.style.display = 'none';
      return;
    }

    if (!roadName) {
      resultDiv.innerHTML = '<p style="color:red; padding:10px;">è«‹è¼¸å…¥è·¯åé—œéµå­—ï¼</p>';
      filtersDiv.style.display = 'none';
      return;
    }

    // ä½ åŸæœ¬çš„ includes è¡Œç‚ºä¿ç•™
    filteredData = csvData.filter(row => {
      const v = row['è·¯å'] || '';
      return v.includes(roadName);
    });

    if (!filteredData.length) {
      resultDiv.innerHTML = `<p style="padding:10px;">æ²’æœ‰æ‰¾åˆ°åŒ…å«ã€Œ${escapeHtml(roadName)}ã€çš„é“è·¯è³‡æ–™ã€‚</p>`;
      filtersDiv.style.display = 'none';
      return;
    }

    populateFilters();
    filtersDiv.style.display = 'block';
    displayResults(filteredData);
  }

  function populateFilters() {
    const areaSet = new Set(filteredData.map(r => r['åœ°å€']).filter(v => v && v !== 'ç„¡è³‡æ–™'));
    const laneSet = new Set(filteredData.map(r => r['å··']).filter(v => v && v !== 'ç„¡è³‡æ–™'));
    const alleySet = new Set(filteredData.map(r => r['å¼„']).filter(v => v && v !== 'ç„¡è³‡æ–™'));

    const areaFilter = document.getElementById('areaFilter');
    const laneFilter = document.getElementById('laneFilter');
    const alleyFilter = document.getElementById('alleyFilter');

    areaFilter.innerHTML = '<option value="">æ‰€æœ‰åœ°å€</option>';
    laneFilter.innerHTML = '<option value="">æ‰€æœ‰å··</option>';
    alleyFilter.innerHTML = '<option value="">æ‰€æœ‰å¼„</option>';

    [...areaSet].sort().forEach(v => areaFilter.add(new Option(v, v)));
    [...laneSet].sort().forEach(v => laneFilter.add(new Option(v, v)));
    [...alleySet].sort().forEach(v => alleyFilter.add(new Option(v, v)));
  }

  function applyFilters() {
    const area = document.getElementById('areaFilter').value;
    const lane = document.getElementById('laneFilter').value;
    const alley = document.getElementById('alleyFilter').value;

    const results = filteredData.filter(r => {
      const okA = !area  || r['åœ°å€'] === area;
      const okL = !lane  || r['å··'] === lane;
      const okAl= !alley || r['å¼„'] === alley;
      return okA && okL && okAl;
    });

    displayResults(results);
  }

  function displayResults(results) {
    const resultDiv = document.getElementById('result');

    if (!results.length) {
      resultDiv.innerHTML = '<p style="padding:10px;">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™ã€‚</p>';
      return;
    }

    let html = `
      <p style="margin:20px 0; font-weight:bold;">æ‰¾åˆ° ${results.length} ç­†è³‡æ–™ï¼š</p>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>è·¯å</th>
            <th>åœ°å€</th>
            <th>å··</th>
            <th>å¼„</th>
            <th>è·¯å¯¬</th>
          </tr>
        </thead>
        <tbody>
    `;

    results.forEach((item, idx) => {
      html += `
        <tr>
          <td>${idx + 1}</td>
          <td>${escapeHtml(item['è·¯å'] || 'ç„¡è³‡æ–™')}</td>
          <td>${escapeHtml(item['åœ°å€'] || 'ç„¡è³‡æ–™')}</td>
          <td>${escapeHtml(item['å··'] || 'ç„¡è³‡æ–™')}</td>
          <td>${escapeHtml(item['å¼„'] || 'ç„¡è³‡æ–™')}</td>
          <td class="road-width">${escapeHtml(item['è·¯å¯¬'] || 'ç„¡è³‡æ–™')}</td>
        </tr>
      `;
    });

    html += `</tbody></table>`;
    resultDiv.innerHTML = html;
  }
</script>
</body>
</html>
